version: '3.9'

services:
  web-backend:
    build: ./web_backend
    environment:
      MOCK_ML_MODELS: "false"
      TORCH_BACKEND_URL: "http://torchserve:8084"
      POSTGRES_DB_URL: "postgresql://postgres:postgres@postgres:5432/"
      FLASK_SECRET_KEY: "[YOUR_SECRET_KEY]"
      ETHERPAD_API_KEY: "[YOUR_ETHERPAD_KEY]"
      ETHERPAD_API_URL: "http://etherpad:9001/api"
    command: gunicorn main:app -w 2 --threads 2 -b 0.0.0.0:7777
    ports:
      - 7777:7777

  torchserve:
    build: ./torchserve_whisper
    command: torchserve --start --ts-config /torch-config.cnf --model-store /torch_model_dir --models bart=bart-large-xsum.mar whisper=whisper-base.mar
    volumes:
     - ./torch_model_dir:/torch_model_dir
     - ./torch-config.cnf:/torch-config.cnf
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  postgres:
    image: 'postgres'
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - db:/var/lib/postgres/data
      - ./web_backend/db/create_db.sql:/docker-entrypoint-initdb.d/create_tables.sql

  etherpad:
    build: ./etherpad-lite
    ports:
      - 9001:9001

volumes:
  db:
    driver: local
